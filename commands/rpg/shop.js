let itemsShop = {
	buy: {
		pickaxe: {
			money: 5000,
			database: "mining",
			pickaxeDurability: 200,
			max: 5
		},
		fishingrod: {
			money: 2000,
			database: "mancing",
			fishingrodDurability: 200,
			max: 5
		},
		sword: {
			money: 2000,
			database: "hunting",
			max: 5,
			swordDurability: 200
		},
		axe: {
			money: 2000,
			database: "chop",
			axeDurability: 200,
			max: 5
		},
		limit: {
			exp: 500,
			database: "user"
		},
		exp: {
			money: 8,
			database: "user"
		},
		bibitApel: {
			money: 1,
			database: "tanam"
		},
		bibitPisang: {
			money: 1,
			database: "tanam"
		},
		bibitMangga: {
			money: 1,
			database: "tanam"
		},
		bibitJagung: {
			money: 1,
			database: "tanam"
		},
		bibitSemangka: {
			money: 1,
			database: "tanam"
		},
		bibitTimun: {
			money: 1,
			database: "tanam"
		},
		bibitTomat: {
			money: 1,
			database: "tanam"
		},
		bibitWortel: {
			money: 1,
			database: "tanam"
		},
		bibitStroberi: {
			money: 1,
			database: "tanam"
		},
		bibitBlueberi: {
			money: 1,
			database: "tanam"
		},
		apel: {
			money: 5,
			database: "tanam"
		},
		pisang: {
			money: 3,
			database: "tanam"
		},
		mangga: {
			money: 7,
			database: "tanam"
		},
		jagung: {
			money: 9,
			database: "tanam"
		},
		semangka: {
			money: 20,
			database: "tanam"
		},
		timun: {
			money: 3,
			database: "tanam"
		},
		tomat: {
			money: 4,
			database: "tanam"
		},
		wortel: {
			money: 4,
			database: "tanam"
		},
		stroberi: {
			money: 2,
			database: "tanam"
		},
		blueberi: {
			money: 2,
			database: "tanam"
		},
		kepiting: {
			money: 120,
			database: "mancing"
		},
		cumi: {
			money: 150,
			database: "mancing"
		},
		buntal: {
			money: 500,
			database: "mancing"
		},
		dory: {
			money: 300,
			database: "mancing"
		},
		lumba: {
			money: 700,
			database: "mancing"
		},
		lobster: {
			money: 230,
			database: "mancing"
		},
		udang: {
			money: 30,
			database: "mancing"
		},
		ikan: {
			money: 12,
			database: "mancing"
		},
		diamond: {
			money: 5000,
			database: "mining"
		},
		iron: {
			money: 3000,
			database: "mining"
		},
		gold: {
			money: 4000,
			database: "mining"
		},
		stone: {
			money: 5,
			database: "mining"
		},
		titanium: {
			money: 2700,
			database: "mining"
		},
		uranium: {
			money: 2900,
			database: "mining"
		},
		aluminium: {
			money: 2100,
			database: "mining"
		},
		panda: {
			money: 1400,
			database: "hunting"
		},
		kerbau: {
			money: 620,
			database: "hunting"
		},
		monyet: {
			money: 540,
			database: "hunting"
		},
		ayam: {
			money: 50,
			database: "hunting"
		},
		bebek: {
			money: 50,
			database: "hunting"
		},
		sapi: {
			money: 710,
			database: "hunting"
		},
		babi: {
			money: 110,
			database: "hunting"
		},
		kambing: {
			money: 321,
			database: "hunting"
		},
		armor: {
			money: 4000,
			database: "dungeon"
		},
		potion: {
			money: 100,
			database: "dungeon"
		},
		common: {
			money: 600,
			database: "crate"
		},
		uncommon: {
			money: 900,
			database: "crate"
		},
		rare: {
			money: 1700,
			database: "crate"
		},
		legendary: {
			money: 2500,
			database: "crate"
		},
		mythical: {
			money: 5000,
			database: "crate"
		},
		artefact: {
			money: 10000,
			database: "crate"
		},
		pet: {
			money: 200,
			database: "crate"
		},
		trash: {
			money: 7,
			database: "crate"
		},
		pohon: {
			money: 1500,
			database: "chop"
		},
		beringin: {
			money: 4000,
			database: "chop"
		},
		bambu: {
			money: 300,
			database: "chop"
		},
		kayu: {
			money: 500,
			database: "chop"
		},
		rotan: {
			money: 10,
			database: "chop"
		},
		palem: {
			money: 1000,
			database: "chop"
		}
	},
	sell: {
		kepiting: {
			money: 105,
			database: "mancing"
		},
		cumi: {
			money: 135,
			database: "mancing"
		},
		buntal: {
			money: 420,
			database: "mancing"
		},
		dory: {
			money: 190,
			database: "mancing"
		},
		lumba: {
			money: 620,
			database: "mancing"
		},
		lobster: {
			money: 180,
			database: "mancing"
		},
		udang: {
			money: 20,
			database: "mancing"
		},
		ikan: {
			money: 10,
			database: "mancing"
		},
		diamond: {
			money: 3900,
			database: "mining"
		},
		iron: {
			money: 2000,
			database: "mining"
		},
		gold: {
			money: 2900,
			database: "mining"
		},
		stone: {
			money: 5,
			database: "mining"
		},
		titanium: {
			money: 2100,
			database: "mining"
		},
		uranium: {
			money: 2300,
			database: "mining"
		},
		aluminium: {
			money: 1700,
			database: "mining"
		},
		panda: {
			money: 1000,
			database: "hunting"
		},
		kerbau: {
			money: 400,
			database: "hunting"
		},
		monyet: {
			money: 300,
			database: "hunting"
		},
		ayam: {
			money: 120,
			database: "hunting"
		},
		bebek: {
			money: 125,
			database: "hunting"
		},
		sapi: {
			money: 600,
			database: "hunting"
		},
		babi: {
			money: 100,
			database: "hunting"
		},
		kambing: {
			money: 200,
			database: "hunting"
		},
		armor: {
			money: 2000,
			database: "dungeon"
		},
		bibitApel: {
			money: 1,
			database: "tanam"
		},
		bibitPisang: {
			money: 1,
			database: "tanam"
		},
		bibitMangga: {
			money: 1,
			database: "tanam"
		},
		bibitJagung: {
			money: 1,
			database: "tanam"
		},
		bibitSemangka: {
			money: 1,
			database: "tanam"
		},
		bibitTimun: {
			money: 1,
			database: "tanam"
		},
		bibitTomat: {
			money: 1,
			database: "tanam"
		},
		bibitWortel: {
			money: 1,
			database: "tanam"
		},
		bibitStroberi: {
			money: 1,
			database: "tanam"
		},
		bibitBlueberi: {
			money: 1,
			database: "tanam"
		},
		apel: {
			money: 3,
			database: "tanam"
		},
		pisang: {
			money: 3,
			database: "tanam"
		},
		mangga: {
			money: 3,
			database: "tanam"
		},
		jagung: {
			money: 3,
			database: "tanam"
		},
		semangka: {
			money: 3,
			database: "tanam"
		},
		timun: {
			money: 3,
			database: "tanam"
		},
		tomat: {
			money: 3,
			database: "tanam"
		},
		wortel: {
			money: 3,
			database: "tanam"
		},
		stroberi: {
			money: 3,
			database: "tanam"
		},
		blueberi: {
			money: 3,
			database: "tanam"
		},
		potion: {
			money: 23,
			database: "dungeon"
		},
		common: {
			money: 500,
			database: "crate"
		},
		uncommon: {
			money: 700,
			database: "crate"
		},
		rare: {
			money: 1000,
			database: "crate"
		},
		legendary: {
			money: 1800,
			database: "crate"
		},
		mythical: {
			money: 3200,
			database: "crate"
		},
		artefact: {
			money: 6000,
			database: "crate"
		},
		pet: {
			money: 130,
			database: "crate"
		},
		trash: {
			money: 3,
			database: "crate"
		},
		pohon: {
			money: 1350,
			database: "chop"
		},
		beringin: {
			money: 3400,
			database: "chop"
		},
		bambu: {
			money: 250,
			database: "chop"
		},
		kayu: {
			money: 420,
			database: "chop"
		},
		rotan: {
			money: 5,
			database: "chop"
		},
		palem: {
			money: 890,
			database: "chop"
		}
	}
}

function removeDuplicateData(arr) {
  return arr.filter((item, index) => {
    return arr.indexOf(item) === index;
  });
}
function listItems(items) {
    const allItems = Object.keys(items.buy).concat(Object.keys(items.sell)).sort()
    const removedDuplicateData = removeDuplicateData(allItems)
    const itemList = removedDuplicateData.map(item => {
        const buyPrice = (items.buy[item]?.money || items.buy[item]?.exp) ? (items.buy[item]?.money || items.buy[item]?.exp) : "-";
        const sellPrice = (items.sell[item]?.money || items.sell[item]?.exp) ? (items.sell[item]?.money || items.sell[item]?.exp) : "-";
        return `${item} || ${buyPrice} || ${sellPrice}`;
    }).join('\n');
    return `${itemList}`;
}


module.exports = [{
    name: "shop",
    tags: "rpg",
    details: { desc: "buy/sell items", usage: "shop buy/sell (items) (quantity)" },
    code: async (zev, m, { args, prefix }) => {
        const type = args[0];
        const item = args[1];
        const total = parseInt(args[2]) || 1
        const user = global.zv.getDataUser(m.sender, "user");
        
        if (!type || !item || !total) {
            let itemList = "";
            if (!type) {
                itemList = `List items yang tersedia:\nItemName || Harga beli || Harga jual\n${listItems(itemsShop)}`;
            } else {
                const itemListData = itemsShop[type];
                const typeItems = type === "buy" ? "beli" : "jual"
                if (!itemListData) return zev.reply(m.chat, `Tipe transaksi '${type}' tidak valid`, m)
                itemList = `List items yang tersedia:\nItemName || Harga ${typeItems} \n${Object.entries(itemListData).map(([itemName, itemData]) => `${itemName} || ${(itemData.money || itemData.exp) ? (itemData.money || itemData.exp) : "-"}`).join('\n')}`;
            }
            return zev.reply(m.chat, `Format:
${prefix}shop sell/buy (items) (quantity)
Example:
${prefix}shop ${(type || "buy")} apel 1

${itemList}
`.trim(), m);
        }
        
        const itemList = itemsShop[type]
        if (!itemList) return zev.reply(m.chat, `Tipe transaksi '${type}' tidak valid`, m)
        
        const selectedItem = itemList[item];
        if (!selectedItem) return zev.reply(m.chat, `Item '${item}' tidak tersedia untuk ${type}`, m);

        const paymentMethod = Object.keys(selectedItem).find(prop => prop !== "database" && prop !== "max");
        if (!paymentMethod) return zev.reply(m.chat, `Metode pembayaran untuk item '${item}' tidak valid`, m);
        
        const userPayment = global.zv.get(paymentMethod, m.sender, "user") || 0;
        const itemCost = selectedItem[paymentMethod] * total;
        
        if(type === "buy") {
        if (userPayment < itemCost) return zev.reply(m.chat, `${paymentMethod === "money" ? "Uang" : "Exp"}mu tidak cukup untuk membeli item ini\ncoba ${prefix}daily / ${prefix}weekly / ${prefix}monthly untuk mendapatkan sesuatu`, m)
        
        const maxItem = selectedItem.max || Infinity;
        const currentTotal = global.zv.get(item, m.sender, selectedItem.database) || 0;

        if (total + currentTotal > maxItem) return zev.reply(m.chat, `Kamu hanya dapat memiliki maksimal ${maxItem} ${item}, ${item} mu sekarang ${currentTotal}`, m)

        global.zv.set(paymentMethod, userPayment - itemCost, m.sender, "user");

        for (const prop in selectedItem) {
            if (prop !== paymentMethod && prop !== "database" && prop !== "max") {
                let userData = global.zv.get(prop, m.sender, selectedItem.database) || 0;
                userData += selectedItem[prop] * total
                global.zv.set(prop, userData, m.sender, selectedItem.database); 
            }
        }

        let itemData = global.zv.get(item, m.sender, selectedItem.database) || 0;
        itemData += total
        global.zv.set(item, itemData, m.sender, selectedItem.database);

        return zev.reply(m.chat, `Sukses membeli ${item} sejumlah ${total} dan ${paymentMethod}mu berkurang ${itemCost}`, m)
        
    } else if(type === "sell") {
    const itemInInventory = global.zv.get(item, m.sender, selectedItem.database) || 0;

            if (itemInInventory < total) return zev.reply(m.chat, `Kamu tidak memiliki cukup ${item} untuk dijual`, m)

            global.zv.set(paymentMethod, userPayment + (selectedItem[paymentMethod] * total), m.sender, "user");

            for (const prop in selectedItem) {
                if (prop !== paymentMethod && prop !== "database" && prop !== "max") {
                    let userData = global.zv.get(prop, m.sender, selectedItem.database) || 0;
                    userData -= selectedItem[prop] * total;
                    global.zv.set(prop, userData, m.sender, selectedItem.database); 
                }
            }

            let itemData = global.zv.get(item, m.sender, selectedItem.database) || 0;
            itemData -= total;
            global.zv.set(item, m.sender, itemData, selectedItem.database);

            return zev.reply(m.chat, `Sukses menjual ${item} sejumlah ${total} dan ${paymentMethod}mu bertambah ${itemCost}`, m)
            
        }
   }
}];